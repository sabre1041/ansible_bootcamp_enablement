= Configuration as Code

== Building out the basics for config as code

[#setup]
=== Task 1 - Setting up the project

- In this lab, you will be creating configuration files in order to set a state on the Ansible Automation Platform.
This requires several prerequisites.

- Open up the terminal in the window on the right by going to the menu, use the Terminal > New Terminal

- In the terminal, install the collections and containers.podman using `ansible-galaxy` command. Make sure the versions are correct and you are running command from the path `/home/lab-user/casc_lab/`.
+
[source,bash,role=execute]
----
cd /home/lab-user/casc_lab/
----
+
[source,bash,role=execute]
----
ansible-galaxy collection install infra.ee_utilities:4.0.0 infra.aap_configuration:3.1.0 containers.podman:1.16.3 community.general:10.4.0 ansible.hub:1.0.0 ansible.platform:2.5.20250213 ansible.controller:4.6.8
----

- Further documentation for those who are interested to learn more see:
+
* https://docs.ansible.com/ansible/devel/user_guide/collections_using.html#collections[Installing collections using cli,window=_blank]
* https://docs.ansible.com/ansible-tower/latest/html/userguide/projects.html#collections-support[Using collections in AAP,window=_blank]



[#variable_files]
=== Task 2 - Creating Variable Files

**In the next few steps pay attention to the folder paths and make sure to put the files in the correct folders you can either use vscode editor or the ssh terminal to do the below changes** 

- Set the `variables` to be used in the collections for use. These include hosts, usernames, and other variables that are reused in each role.

- The variables are defined in the file `group_vars/all/auth.yml`. 
+
[source,yaml,role=execute]
group_vars/all/auth.yml

With the following content:

[source,yaml,role=execute]
----
aap_username: "{{ student_account }}"
aap_password: "{{ aap_password }}"
aap_validate_certs: false
aap_request_timeout: 60

ee_pull_collections_from_hub: false
aap_service_account_username: aap_service_account

ee_registry_username: "{{ aap_username }} "
ee_registry_password: "{{ aap_password }}"
ee_registry_dest: "{{ aap_hostname }}/config"

ee_base_registry: "{{ aap_hostname }}"
ee_base_registry_username: "{{ aap_username }}"
ee_base_registry_password: "{{ aap_password }}"
ee_validate_certs: false
----

WARNING: Do not replace the content that is already in this file but append/paste below it.

- Further documentation are provided below for those who are interested to learn more:

* https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html#organizing-host-and-group-variables[more about group_vars,window=_blank]


[#inventory]
=== Task 3 - Creating our inventory file

- Create your inventory file `inventory.yml`, copy the content below to the file.
+
[source,yaml,role=execute]
----
---
all:
  children:
    automationcontroller:
      hosts:
        control:
          ansible_host: "{{ aap_hostname | regex_replace('^https://', '')  }}"
    execution:
      hosts:
        localhost:
          ansible_connection: local
...
----
+
WARNING: These are hostnames and should not have 'https://', otherwise things will fail

- Further documentation are provided below for those who are interested to learn more:
+
* https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html#inventory-basics-formats-hosts-and-groups[More about inventories,window=_blank]
* https://docs.ansible.com/ansible-tower/latest/html/userguide/inventories.html#add-source[How to use this source in AAP,window=_blank]

[#vault]
=== Task 4 - Create our Vault

- A `vault.yml` has been prepoulated, please review this as it provides a source for most of the passwords and secrets used in the lab.
- Your username should be: {ssh_username}
- Your password should be: {ssh_password}
+
[source,yaml,role=execute]
----
---
aap_password: ### Insert Password here
aap_service_account_password: ### Insert Password here
student_account: ### Insert Username here
vault_pass: cascLB2193
...
----
+
TIP: The easiest way to do this is have all passwords be the provided password.
+
NOTE: For good configuration as code we recommend retrieving passwords from secure systems secret management systems (such as Hashicorp Vault).

- Create a `.password` file and put a password in it. This is the password vault uses to encrypt secrets.
+
[source,bash,role=execute]
----
cat <<EOF > .password
cascLB2193
EOF
----
+
IMPORTANT: **We do not recommend using .password files outside of lab environment** This process is just to simplify/speed up the lab.

- The `ansible.cfg` file points to the `.password` file. This has been preopulated, but please review the ansible.cfg file to see how this lab is connected to hub and uses the password file.
+
[source,bash,role=execute]
----
[defaults]
vault_password_file=.password
----
+
Encrypt vault with the password in the .password file
+
[source,bash,role=execute]
----
ansible-vault encrypt vault.yml
----

- Further documentation are provided below for those who are interested to learn more:
+
* https://docs.ansible.com/ansible/latest/user_guide/vault.html[Ansible vaults,window=_blank]
* https://ansible.readthedocs.io/projects/navigator/faq/#how-can-i-use-a-vault-password-with-ansible-navigator[Vault with navigator,window=_blank]

[#organizations]
=== Task 5 - Create organizations

- Create a file `group_vars/all/organizations.yml`
+
[source,yaml,role=execute]
----
---
aap_organizations:
  - name: config_as_code
...
----


- Further documentation are provided below for those who are interested to learn more:
+
* https://github.com/redhat-cop/infra.aap_configuration/tree/devel/roles/gateway_organizations[Organizations role,window=_blank]


[#team setup]
=== Task 6 - Create a Team

- Create a file `group_vars/all/teams.yml`
+
[source,yaml,role=execute]
----
---
aap_teams:
  - name: config as code team
    description: config as code team
    organization: config_as_code
...
----

- Further documentation are provided below for those who are interested to learn more:
+
* https://github.com/redhat-cop/infra.aap_configuration/tree/devel/roles/gateway_teams[Teams role,window=_blank]

[#service_account]
=== Task 7 - Create a local service account user

- Create a file `group_vars/all/users.yml` with the below information:
+
[source,yaml,role=execute]
----
---
aap_user_accounts:
  - username: "{{ aap_service_account_username }}"
    password: "{{ aap_service_account_password }}"
    is_superuser: true
    state: "present"
...
----

- Further documentation are provided below for those who are interested to learn more:
+
* https://github.com/redhat-cop/infra.aap_configuration/tree/devel/roles/gateway_users[Users role,window=_blank]

[#repositories]
=== Task 8 - Create Collection Repositories and Remotes

- Create a file `group_vars/all/hub_repositories.yml` to create the list of community repositories and their remote counterpart.
+
[source,yaml,role=execute]
----
---
hub_collection_remotes:
  - name: community-infra
    url: 'https://galaxy.ansible.com/'
    sync_dependencies: false
    requirements:
      - name: infra.ee_utilities
        version: '>=4.0.0'
      - name: infra.aap_utilities
        version: '>=2.5.2'
      - name: containers.podman
        version: '>=1.13.0'
      - name: community.general
        version: '>=10.4.0'
      - name: infra.aap_configuration
        version: '>=3.1.0'
hub_collection_repositories:
  - name: community-infra-repo
    description: description of community-infra repository
    pulp_labels:
      pipeline: approved
    distribution:
      state: present
    remote: community-infra
hub_configuration_collection_repository_sync_async_delay: 5
hub_configuration_collection_repository_sync_async_retries: 150
...
----

- Further documentation are provided below for those who are interested to learn more:
+
* https://github.com/redhat-cop/infra.aap_configuration/tree/devel/roles/hub_collection_repository[Hub collection repository role,window=_blank]
* https://github.com/redhat-cop/infra.aap_configuration/tree/devel/roles/hub_collection_remote[Hub collection remote role,window=_blank]

[#playbook_create]
=== Task 9 - Create a playbook to apply the configuration

- The next step is to create the `playbooks/aap_config.yml` playbook. This playbook will execute the `aap_configuration` dispatch role, applying the provided configurations in the necessary order.
+
[source,yaml,role=execute]
----
---
- name: Playbook to configure ansible controller post installation
  hosts: all
  gather_facts: false
  vars_files:
    - ../vault.yml
  connection: local
  tasks:
    - name: Call dispatch role
      ansible.builtin.include_role:
        name: infra.aap_configuration.dispatch
...
----

- Further documentation are provided below for those who are interested to learn more:
+
* https://github.com/redhat-cop/infra.aap_configuration/tree/devel/roles/dispatch[Dispatch role,window=_blank]

=== Task 10 - Check your paths

- Here's the desired layout for your folders from the `/home/lab-user/casc_lab`. Please examine the file organization to confirm that each file resides in its correct location within this structure. Run the `+tree+` command to verify. 
+
[source,bash]
----
.
├── ansible.cfg
├── group_vars
│   └── all
│       ├── auth.yml
│       ├── hub_repositories.yml
│       ├── organizations.yml
│       ├── teams.yml
│       └── users.yml
├── inventory.yml
├── playbooks
│   └── aap_config.yml
└── vault.yml

3 directories, 9 files
----


[#playbook_run]
=== Task 11 - Put the playbook into action

- The next step is to run this playbook, this kicks off the initial setup for everything we've just created for the Ansible Automation Platform.
+
[source,bash,role=execute]
----
ansible-playbook playbooks/aap_config.yml -i inventory.yml -l execution
----

- While the playbook is running you can go to the Automation Hub tab and peak at the Task Management to see the repository syncing process
+
image::04-configuration-as-code/hub_task.png[Hub task,125%,125%,link=self, window=blank]

[#results]
=== Task 12 - Validate configuration was applied
- Navigate to the AAP console and login with the provided passwords (You will find the link to the console on the start page of this lab)

Check that the following objects have been correctly created on AAP and are aligned with the instructions above

. Org
. Repository
. User
. Team

=== ✅ Next Challenge

Once you’ve completed the above tasks we will move towards doing the Controller configuration. 

== Configuring the Automation controller

In this section, you will only be given a summary of the objects you
need to create along with some screenshots of a controller that is
configured with the completed code. You will also be provided the
variables sections from the readme’s for each of the required roles to
help you complete this task.

=== Task 1 - Configure settings

- Create a file `group_vars/all/settings.yml` with the below content.
+ 
[source,yaml,role=execute]
----
---
controller_settings:
  settings:
    GALAXY_IGNORE_CERTS: true
...
----

- Further documentation are provided below for those who are interested to learn more:

* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_settings[Settings role,window=_blank]

=== Task 2 - Configure Execution Environments

- Create a file `group_vars/all/execution_environments.yml` and add the required information to the list `controller_execution_environments`
to include a new EE (that we will show how to create with code in the next module) called `config_as_code` with image path `{{ aap_hostname }}/config_as_code` that is pull `always` and uses the credential `cr_ah`.
+
image::04-configuration-as-code/config_ee.png[title="Config Execution Environment",125%,125%, link=self, window=blank]
image::04-configuration-as-code/minimal_ee.png[title="Minimal Execution Environment",125%,125%, link=self, window=blank]
image::04-configuration-as-code/supported_ee.png[title="Supported Execution Environment",125%,125%, link=self, window=blank]

[source,yaml,role=execute]
----
---
controller_execution_environments:
  - name: "supported"
    image: "{{ aap_hostname }}/ee-supported-rhel8"
    pull: always
    credential: cr_ah

  - name: "minimal"
    image: "{{ aap_hostname }}/ee-minimal-rhel8"
    pull: always
    credential: cr_ah

...

----
NOTE: While you have not created this EE yet it, we have already added a version to hub so this won't fail.

- Further documentation for those who are interested to learn more see:
+
* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_execution_environments[Execution Environments role,window=_blank]

=== Task 3 - Create credential types

- Create a file `group_vars/all/credential_types.yml` where we will create a list called `controller_credential_types` that has 5 variables per item defined below:

* `name` this is required and will be what the credential type will be
called
* `description` this is the description of the credential type
* `kind` The type of credential type being added. Note that only cloud
and net can be used for creating credential types.
* `inputs` Enter inputs using either JSON or YAML syntax. Refer to the
Ansible controller documentation for example syntax. These will be the
fields in the GUI that prompt the user for input.
* `injectors` Enter injectors using either JSON or YAML syntax. Refer
to the Ansible controller documentation for example syntax. These are
the variables that will then be useable in a job.
+
The role will iterate through this list and for each item in this list it will create custom credential types for using it in the controller.
+
[source,yaml,role=execute]
----
---
controller_credential_types:
  - name: automation_hub
    description: automation hub
    kind: cloud
    inputs:
      fields:
        - id: verify_ssl
          type: boolean
          label: Verify SSL
        - id: hostname
          type: string
          label: Hostname
        - id: username
          type: string
          label: Username
        - id: password
          type: string
          label: Password
          secret: true
        - id: token
          type: string
          label: Token
          secret: true
      required:
        - hostname
    injectors:
      env:
        AAP_PASSWORD: !unsafe "{{ password }}"
        AAP_USERNAME: !unsafe "{{ username }}"
        AAP_HOSTNAME: !unsafe # Insert appropriate variable from above here
        AAP_TOKEN: !unsafe # Insert appropriate variable from above here
        AAP_VALIDATE_CERTS: !unsafe # Insert appropriate variable from above here
      extra_vars:
        aap_password: !unsafe "{{ password }}"
        aap_username: !unsafe "{{ username }}"
        aap_hostname: !unsafe # Insert appropriate variable from above here
        aap_token: !unsafe # Insert appropriate variable from above here
        aap_validate_certs: !unsafe # Insert appropriate variable from above here

  - name: ssh_priv_file
    kind: cloud
    description: creates temp ssh priv key to use (cannot have passphrase)
    inputs:
      fields:
        - id: priv_key
          type: string
          label: Certificate
          format: ssh_private_key
          multiline: true
          secret: true
    injectors:
      env:
        MY_CERT_FILE_PATH: !unsafe '{{ tower.filename.cert_file }}'
      file:
        template.cert_file: !unsafe '{{ priv_key }}'
...
----

- Further documentation for those who are interested to learn more see:
+
* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_credential_types[Credential types role,window=_blank]

=== Task 4 - Create credentials

- Create a file `group_vars/all/credentials.yml` and add the required information to the list `controller_credentials` to configure the UI to look like the screenshot. Make it to look like the screenshot, but make sure to use parameters for the values.
*DO NOT PASTE YOUR PASSWORD IN CLEARTEXT FOR CREDENTIALS!*
+
[source,yaml,role=execute]
----
---
controller_credentials:
  - name: aap_admin
    credential_type: Red Hat Ansible Automation Platform
    organization: config_as_code
    description: aap admin account
    inputs:
      host: "{{ aap_hostname }}"
      username: "{{ aap_username }}"
      password: "{{ aap_password }}"
      verify_ssl: false

  - name: hub_service_account
    credential_type: automation_hub
    organization: config_as_code
    description: automation hub api account
    inputs:
      hostname: "{{ aap_hostname }}"
      username: "{{ aap_service_account_username }}"
      token: "{{ hub_token }}"
      verify_ssl: false

  - name: hub_certified
    credential_type: "Ansible Galaxy/Automation Hub API Token"
    organization: config_as_code
    inputs:
      url: "https://{{ aap_hostname }}/pulp_ansible/galaxy/rh-certified/"
      token: "{{ hub_token }}"

  - name: hub_published
    credential_type:  "Ansible Galaxy/Automation Hub API Token"
    organization: config_as_code
    inputs:
      url: "https://{{ aap_hostname }}/pulp_ansible/galaxy/published/"
      token: "{{ hub_token }}"

  - name: hub_community
    credential_type:  "Ansible Galaxy/Automation Hub API Token"
    organization: config_as_code
    inputs:
      url: "https://{{ aap_hostname }}/pulp_ansible/galaxy/community/"
      token: "{{ hub_token }}"

  - name: hub_community_infra_repo
    credential_type:  "Ansible Galaxy/Automation Hub API Token"
    organization: config_as_code
    inputs:
      url: "https://{{ aap_hostname }}/pulp_ansible/galaxy/community-infra-repo/"
      token: "{{ hub_token }}"

  - name: cr_ah
    credential_type: Container Registry
    organization: config_as_code
    inputs:
      host: "{{ aap_hostname }}"
      username: "{{ aap_username }}"
      password: "{{ aap_password }}"
      verify_ssl: false

  - name: vault
    credential_type: Vault
    organization: config_as_code
    description: vault password
    inputs:
      vault_password: "{{ vault_pass }}"
...
----
+
image::04-configuration-as-code/credential.png[title="Credential",125%,125%, link=self, window=blank]

- Further documentation for those who are interested to learn more see:
+
* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_credentials[Credentials role,window=_blank]

=== Task 5 - Create organizations

- Update the file `group_vars/all/organizations.yml` and add the required information to the list `aap_organizations` to configure the UI to look like the screenshot. Here we are adding the credentials that we created above to the Organization so we can pull collections from Automation Hub.
+
image::04-configuration-as-code/orgs.png[title="Config as Code Organization",125%,125%, link=self, window=blank]
+
[source,yaml,role=execute]
----
---
aap_organizations:
...
----

- Further documentation for those who are interested to learn more see:

* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/gateway_organizations[Organizations role,window=_blank]

=== Task 6 - Create projects

- Create a file `group_vars/all/projects.yml` and add the required
information to the list `controller_projects` to configure the UI to
look like the screenshot. The project you want to use is
+
----
https://github.com/redhat-cop/aap_configuration_template
----
+
WARNING: There are some values such as `project base path`, `playbook directory`, and `source control version` that are generated by AAP and are not options

NOTE: You will want to refer to the role documentation to determine which options need to be set
// TODO - What git project are we pointing at? Also, perhaps consider providing a table with the values they need to set so they can at least copy/paste URLs etc, but still have to look up the options required
+
[source,yaml,role=execute]
----
---
controller_configuration_projects_async_delay: 5
controller_projects:

...
----

+
image::04-configuration-as-code/project.png[title="Project",125%,125%, link=self, window=_blank]

- Further documentation for those who are interested to learn more see:
+
* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_projects[Projects role,window=_blank]

=== Task 7 - Create inventories

- Create a file `group_vars/all/inventories.yml` and add the required
information to the list `controller_inventories` to configure the UI
to look like the screenshot
+
[source,yaml,role=execute]
----
---
controller_inventories:
...
----
+
image::04-configuration-as-code/inventories.png[title="Inventory",125%,125%, link=self, window=_blank]

- Further documentation for those who are interested to learn more see:

* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_inventories[Inventories role,window=_blank]

=== Task 8 - Create inventory sources

- Add to file `group_vars/all/inventory_sources.yml` and a new variable with the required information to the list `controller_inventory_sources` to configure the UI to look like the screenshot
+
[source,yaml,role=execute]
----
---
controller_inventory_sources:
...
----
+
image::04-configuration-as-code/inventory_sources.png[title="Inventory Sources",125%,125%, link=self, window=_blank]

- Further documentation for those who are interested to learn more see:
+
* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_inventory_sources[Inventory sources role,window=_blank]

=== Task 9 - Create job_templates

- Create a file `group_vars/all/job_templates.yml` and add the required
information to the list `controller_templates` to configure the UI to like the screenshot. 
+
Pay attention to the credentials attached to each job template.
+
[source,yaml,role=execute]
----
---
controller_templates:

...
----
+
image::04-configuration-as-code/aap_config_template_v2.png[title="AAP Config Template",125%,125%, link=self, window=_blank]
image::04-configuration-as-code/build_ee_template_v2.png[title="Build EE Template",125%,125%, link=self, window=_blank]

- Further documentation for those who are interested to learn more see:
+
* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_job_templates[Job templates role,window=_blank]

=== Task 10 - Update the Playbook
==== Update the playbook to get the hub token for the configuration

- We need to create a token from Automation Hub so that we can provide it to the Platform for the collection syncing to take place.
+
The next step is to create a playbook/file `playbooks/aap_config.yml` that will call the aap_configuration dispatch role which will apply all provided configurations in the order that they need to be created.
+
[source,yaml,role=execute]
----
---
- name: Playbook to configure ansible controller post installation
  hosts: all
  gather_facts: false
  vars_files:
    - ../vault.yml
  connection: local
  tasks:
    - name: Authenticate and get an API token from Automation Hub
      ansible.hub.ah_token:
        ah_host: "{{ aap_hostname }}"
        ah_username: "{{ aap_username }}"
        ah_password: "{{ aap_password }}"
        ah_path_prefix: 'galaxy'  # this is for private automation hub
        ah_verify_ssl: false
    - name: Fixing format
      ansible.builtin.set_fact:
        hub_token: "{{ ah_token['token'] }}"
    - name: Call dispatch role
      ansible.builtin.include_role:
        name: infra.aap_configuration.dispatch
...
----

=== Task 11 - Run the playbook

- Run `/home/lab-user/casc_lab/playbooks/aap_config` playbook.
+
[source,console]
----
ansible-playbook playbooks/aap_config.yml -i inventory.yml -l execution
----

- If you run into problems, look back at the section that failed, and check the documentation for that role that was linked. If the output was hidden, look for 'Secure logging variables' on the https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_credentials[controller_credentials role documentation].

TIP: If you run into an error that says "Failed to get token: HTTP Error 401: Unauthorized" while other tasks pass, please rerun the playbook, this is a known issue.

=== Task 12 - See the Results

- After the playbook is complete you should be able to navigate to the controller and see all the changes.
