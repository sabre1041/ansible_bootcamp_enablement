= Lab: Configuration as Code

[abstract]
Learn how to manage your entire Ansible Automation Platform configuration as code using Ansible playbooks. This includes configuring organizations, teams, users, credentials, projects, inventories, job templates, and execution environments through automated, version-controlled processes.

== Learning Objectives

After completing this module, you will be able to:

* Understand the principles of infrastructure and configuration as code
* Configure AAP organizations, teams, and users programmatically
* Manage credentials, projects, and inventories through code
* Create and configure job templates via automation
* Implement execution environment management
* Deploy complete AAP configurations using CI/CD pipelines

== Building out the basics for config as code

[#setup]
== 1. Lab Setup: Configuring Your Environment

First, let's build a new EE with all our required collections.

=== 1.1: Build new EE

[source,bash,role=execute,subs="verbatim,attributes",title="execution-environment.yml"]
----
---
version: 3

images:
  base_image:
    name: {aap_controller_web_url}/ansible-automation-platform-25/ee-minimal-rhel9:latest

dependencies:
  system:
    - gcc [platform:rpm]
    - systemd-devel [platform:rpm]
    - python3.11-devel [platform:rpm]
  galaxy:
    collections:
      - name: ansible.platform
      - name: ansible.controller
      - name: ansible.hub
      - name: ansible.eda
      - name: infra.aap_configuration
options:
  package_manager_path: /usr/bin/microdnf

additional_build_steps:
  prepend_galaxy:
    - ARG TOKEN
    - ENV ANSIBLE_GALAXY_SERVER_LIST='published,certified,validated,community'
    - ENV ANSIBLE_GALAXY_SERVER_CERTIFIED_URL='{aap_controller_web_url}/pulp_ansible/galaxy/rh-certified/'
    - ENV ANSIBLE_GALAXY_SERVER_CERTIFIED_TOKEN=$TOKEN
    - ENV ANSIBLE_GALAXY_SERVER_VALIDATED_URL='{aap_controller_web_url}/pulp_ansible/galaxy/validated/'
    - ENV ANSIBLE_GALAXY_SERVER_VALIDATED_TOKEN=$TOKEN
    - ENV ANSIBLE_GALAXY_SERVER_COMMUNITY_URL='{aap_controller_web_url}/pulp_ansible/galaxy/community/'
    - ENV ANSIBLE_GALAXY_SERVER_COMMUNITY_TOKEN=$TOKEN
    - ENV ANSIBLE_GALAXY_SERVER_PUBLISHED_URL='{aap_controller_web_url}/pulp_ansible/galaxy/published/'
    - ENV ANSIBLE_GALAXY_SERVER_PUBLISHED_TOKEN=$TOKEN
----

NOTE: Replace the following values `{aap_controller_web_url}` With the URL of your Private Automation Hub. Also update `YOUR_API_TOKEN_HERE` With the personal API token you just copied from PAH.

=== Task 2: Build and Publish the Execution Environment

[source,bash,role=execute,subs="verbatim,attributes"]
----
# Log in to your PAH container registry
podman login {aap_controller_web_url}

# Build the EE. It will pull the base from PAH, then add our content.
ansible-builder build --tag config_as_code_ee:1.0 --build-arg TOKEN=YOUR_API_TOKEN_HERE

# Tag and push the image to your PAH registry
podman tag localhost/config_as_code_ee:1.0 {aap_controller_web_url}/config_as_code_ee:1.0
podman push {aap_controller_web_url}/config_as_code_ee:1.0
----

[#variable_files]
=== Task 3 - Creating Variable Files

**In the next few steps pay attention to the folder paths and make sure to put the files in the correct folders you can either use vscode editor or the ssh terminal to do the below changes** 

- Set the `variables` to be used in the collections for use. These include hosts, usernames, and other variables that are reused in each role.

- The variables are defined in the file `config/dev/auth.yml`. 

[source,yaml,role=execute,subs="verbatim,attributes",title="config/dev/auth.yml"]
----
aap_hostname: <GATEWAY_HOST>
aap_username: "{{ student_account }}"
aap_password: "{{ aap_password }}"
aap_validate_certs: false
aap_request_timeout: 60

ee_pull_collections_from_hub: true
aap_service_account_username: aap_service_account

ee_registry_username: "{{ aap_username }} "
ee_registry_password: "{{ aap_password }}"
ee_registry_dest: "{{ aap_hostname }}/config"

ee_base_registry: "{{ aap_hostname }}"
ee_base_registry_username: "{{ aap_username }}"
ee_base_registry_password: "{{ aap_password }}"
ee_validate_certs: false
----

WARNING: Do not include https:// in the GATEWAY_HOST value

[#vault]
=== Task 4 - Create our Vault

- The secrets are defined in the file `config/dev/vault.yml`. 
- Your username should be: {aap_controller_admin_user}
- Your password should be: {aap_controller_admin_password}
+
[source,yaml,role=execute,subs="verbatim,attributes",title="config/dev/vault.yml"]
----
---
aap_password: ### Insert Password here
aap_service_account_password: ### Insert Password here
console_token: ### Insert console token here
hub_token: ### Insert hub token here
gitea_pass: ### Insert gitea password here
student_account: admin
vault_pass: cascLB2193
...
----
+
TIP: The easiest way to do this is have all passwords be the provided password.
+
NOTE: For good configuration as code we recommend retrieving passwords from secure systems secret management systems (such as Hashicorp Vault).

- Create a `.password` file and put a password in it. This is the password vault uses to encrypt secrets.
+
[source,bash,role=execute,subs="verbatim,attributes",title=".password"]
----
cascLB2193
----
+
IMPORTANT: **We do not recommend using .password files outside of lab environment** This process is just to simplify/speed up the lab.

- The `ansible.cfg` file points to the `.password` file. This has been preopulated, but please review the ansible.cfg file to see how this lab is connected to hub and uses the password file.
+
[source,bash,role=execute,subs="verbatim,attributes",title="ansible.cfg"]
----
[defaults]
vault_password_file=.password
----
+
Encrypt vault with the password in the .password file
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
ansible-vault encrypt config/dev/vault.yml
----

- Further documentation are provided below for those who are interested to learn more:
+
* https://docs.ansible.com/ansible/latest/user_guide/vault.html[Ansible vaults,window=_blank]
* https://ansible.readthedocs.io/projects/navigator/faq/#how-can-i-use-a-vault-password-with-ansible-navigator[Vault with navigator,window=_blank]

[#organizations]
=== Task 5 - Create organizations

- Create a file `config/all/organizations.yml`
+
[source,yaml,role=execute,subs="verbatim,attributes",title="config/all/organizations.yml"]
----
---
aap_organizations_all:
  - name: config_as_code
...
----


- Further documentation are provided below for those who are interested to learn more:
+
* https://github.com/redhat-cop/infra.aap_configuration/tree/devel/roles/gateway_organizations[Organizations role,window=_blank]


[#team setup]
=== Task 6 - Create a Team

- Create a file `config/all/teams.yml`
+
[source,yaml,role=execute,subs="verbatim,attributes",title="config/all/teams.yml"]
----
---
aap_teams_all:
  - name: config as code team
    description: config as code team
    organization: config_as_code
...
----

- Further documentation are provided below for those who are interested to learn more:
+
* https://github.com/redhat-cop/infra.aap_configuration/tree/devel/roles/gateway_teams[Teams role,window=_blank]

[#service_account]
=== Task 7 - Create a local service account user

- Create a file `config/all/users.yml` with the below information:
+
[source,yaml,role=execute,subs="verbatim,attributes",title="config/all/users.yml"]
----
---
aap_user_accounts_all:
  - username: "{{ aap_service_account_username }}"
    password: "{{ aap_service_account_password }}"
    is_superuser: true
    state: "present"
...
----

=== Task 8 - Create hosts inventory file

- Create a file `hosts` inventory file:
+
[source,bash,role=execute,subs="verbatim,attributes",title="hosts"]
----
[dev]
localhost
----

- Further documentation are provided below for those who are interested to learn more:
+
* https://github.com/redhat-cop/infra.aap_configuration/tree/devel/roles/gateway_users[Users role,window=_blank]

[#repositories]
=== Task 8 - Create Collection Repositories and Remotes

- Create a file `config/all/hub_repositories.yml` to create the list of community repositories and their remote counterpart.
+
[source,yaml,role=execute,subs="verbatim,attributes",title="config/all/hub_repositories.yml"]
----
---
hub_collection_remotes_all:
  - name: rh-certified
    token: "{{ console_token }}"
    url: https://console.redhat.com/api/automation-hub/content/published/
    auth_url: https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token
  - name: validated
    token: "{{ console_token }}"
    url: https://console.redhat.com/api/automation-hub/content/validated/
    auth_url: https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token
  - name: community
    url: https://galaxy.ansible.com/api/
    requirements:
      - containers.podman
      - community.postgresql

hub_collection_repositories:
  - name: rh-certified
    remote: rh-certified
    sync: false
  - name: validated
    remote: validated
    sync: false
  - name: community
    remote: community
    sync: false
hub_configuration_collection_repository_sync_async_delay: 5
hub_configuration_collection_repository_sync_async_retries: 150
...
----

- Further documentation are provided below for those who are interested to learn more:
+
* https://github.com/redhat-cop/infra.aap_configuration/tree/devel/roles/hub_collection_repository[Hub collection repository role,window=_blank]
* https://github.com/redhat-cop/infra.aap_configuration/tree/devel/roles/hub_collection_remote[Hub collection remote role,window=_blank]

[#playbook_create]
=== Task 9 - Create a playbook to apply the configuration

- The next step is to create the `playbooks/aap_config.yml` playbook. This playbook will execute the `aap_configuration` dispatch role, applying the provided configurations in the necessary order.
+
[source,yaml,role=execute,subs="verbatim,attributes",title="playbooks/aap_config.yml"]
----
---
- name: Playbook to configure ansible controller
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    dispatch_include_wildcard_vars: true
  tasks:
    - name: Include common vars
      ansible.builtin.include_vars:
        dir: ../config/all
        extensions:
          - 'yml'

    - name: Include env vars
      ansible.builtin.include_vars:
        dir: "../config/{{ env }}"
        extensions:
          - 'yml'

    - name: Call dispatch role
      ansible.builtin.include_role:
        name: infra.aap_configuration.dispatch

...
----

- Further documentation are provided below for those who are interested to learn more:
+
* https://github.com/redhat-cop/infra.aap_configuration/tree/devel/roles/dispatch[Dispatch role,window=_blank]

=== Task 10 - Check your paths

- Here's the desired layout for your folders from the root of the repo. Please examine the file organization to confirm that each file resides in its correct location within this structure. Run the `+tree+` command to verify.
+
[source,bash]
----
.
├── ansible.cfg
├── ansible-navigator.yml
├── config
│   ├── all
│   │   ├── hub_repositories.yml
│   │   ├── organizations.yml
│   │   ├── teams.yml
│   │   └── users.yml
│   └── dev
│       ├── auth.yml
│       └── vault.yml
├── hosts
└── playbooks
    └── aap_config.yml

4 directories, 9 files
----

=== Task 11 Push repo to new repository

We need to save our work your lab's Gitea.

==== 11.1 Create Gitea Repository

. Log in to your Gitea web interface, with the provided login credentials.
. In the top left of the web interface, click on the '+' symbol and select 'New Repository'.
. On the New Repository page, enter 'ansible_bootcamp_config_as_code' in the Repository Name field.
. Leave everything else as default and click on the button at the bottom, 'Create Repository'.

==== 11.2 Create `.gitignore` file

[source,bash,role=execute,subs="verbatim,attributes",title=".gitignore"]
----
context/
.password
ansible.cfg
.ansible/
.vscode/

----

==== 11.3 Push code to repository

After an empty repository is created on your Gitea, we need to push the collection to the repository.

. In section 'Clone this repository', click the Copy URL button on the far right to copy Gitea repository URL, that will be pasted below in line that starts with 'git remote add origin ...'.
. Now, follow these steps in the root directory of 'config_as_code'

[source,bash,role=execute,subs="verbatim,attributes"]
----
git init
git checkout -b main
git add --all
git commit -m "Uploading config on initial commit"
git remote add origin <PASTE GIT URL FROM GITEA HERE>
git push -u origin main
----

=== Task 12 - Create ansible-navigator configuration file

[source,yaml,role=execute,subs="verbatim,attributes",title="ansible-navigator.yml"]
----
---
ansible-navigator:
  execution-environment:
    image: {aap_controller_web_url}/config_as_code_ee:1.0

----


[#playbook_run]
=== Task 13 - Put the playbook into action

- The next step is to run this playbook, this kicks off the initial setup for everything we've just created for the Ansible Automation Platform.
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
ansible-navigator run -m stdout playbooks/aap_config.yml -e env=dev
----

- While the playbook is running you can go to the Automation Hub tab and peak at the Task Management to see the repository syncing process
+
image::07-configuration-as-code/hub_task.png[Hub task,125%,125%,link=self, window=blank]

[#results]
=== Task 14 - Validate configuration was applied
- Navigate to the AAP console and login with the provided passwords (You will find the link to the console on the start page of this lab)

Check that the following objects have been correctly created on AAP and are aligned with the instructions above

. Org
. Repository
. User
. Team

== Configuring the Automation controller

In this section, you will only be given a summary of the objects you
need to create along with some screenshots of a controller that is
configured with the completed code. You will also be provided the
variables sections from the readme’s for each of the required roles to
help you complete this task.

=== Task 15 - Configure settings

- Create a file `config/all/settings.yml` with the below content.
+
[source,yaml,role=execute,subs="verbatim,attributes",title="config/all/settings.yml"]
----
---
controller_settings_all:
  settings:
    GALAXY_IGNORE_CERTS: true
...
----

- Further documentation are provided below for those who are interested to learn more:

* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_settings[Settings role,window=_blank]

=== Task 16 - Configure Execution Environments

- Create a file `config/all/execution_environments.yml` and add the required information to the list `controller_execution_environments`
to include a new EE (that we will show how to create with code in the next module) called `config_as_code` with image path `{{ aap_hostname }}/config_as_code_ee` that is pull `always` and uses the credential `cr_ah`.
+
image::07-configuration-as-code/config_ee_v2.png[title="Config Execution Environment",125%,125%, link=self, window=blank]

[source,yaml,role=execute,subs="verbatim,attributes",title="config/all/execution_environments.yml"]
----
---
controller_execution_environments_all:
  - name: supported
    image: registry.redhat.io/ansible-automation-platform-25/ee-supported-rhel9
    pull: always

  - name: minimal
    image: registry.redhat.io/ansible-automation-platform-25/ee-minimal-rhel9
    pull: always

...

----

- Link to the roles documenation here:
+
* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_execution_environments[Execution Environments role,window=_blank]

=== Task 17 - Create credential types

- Create a file `config/all/credential_types.yml` where we will create a list called `controller_credential_types` that has 5 variables per item defined below:

* `name` this is required and will be what the credential type will be
called
* `description` this is the description of the credential type
* `kind` The type of credential type being added. Note that only cloud
and net can be used for creating credential types.
* `inputs` Enter inputs using either JSON or YAML syntax. Refer to the
Ansible controller documentation for example syntax. These will be the
fields in the GUI that prompt the user for input.
* `injectors` Enter injectors using either JSON or YAML syntax. Refer
to the Ansible controller documentation for example syntax. These are
the variables that will then be useable in a job.
+
The role will iterate through this list and for each item in this list it will create custom credential types for using it in the controller.
+
[source,yaml,role=execute,subs="verbatim,attributes",title="config/all/credential_types.yml"]
----
---
controller_credential_types_all:
  - name: automation_hub
    description: automation hub
    kind: cloud
    inputs:
      fields:
        - id: verify_ssl
          type: boolean
          label: Verify SSL
        - id: hostname
          type: string
          label: Hostname
        - id: username
          type: string
          label: Username
        - id: password
          type: string
          label: Password
          secret: true
        - id: token
          type: string
          label: Token
          secret: true
      required:
        - hostname
    injectors:
      env:
        AAP_PASSWORD: !unsafe "{{ password }}"
        AAP_USERNAME: !unsafe "{{ username }}"
        AAP_HOSTNAME: !unsafe # Insert appropriate variable from above here
        AAP_TOKEN: !unsafe # Insert appropriate variable from above here
        AAP_VALIDATE_CERTS: !unsafe # Insert appropriate variable from above here
      extra_vars:
        aap_password: !unsafe "{{ password }}"
        aap_username: !unsafe "{{ username }}"
        aap_hostname: !unsafe # Insert appropriate variable from above here
        aap_token: !unsafe # Insert appropriate variable from above here
        aap_validate_certs: !unsafe # Insert appropriate variable from above here

  - name: ssh_priv_file
    kind: cloud
    description: creates temp ssh priv key to use (cannot have passphrase)
    inputs:
      fields:
        - id: priv_key
          type: string
          label: Certificate
          format: ssh_private_key
          multiline: true
          secret: true
    injectors:
      env:
        MY_CERT_FILE_PATH: !unsafe '{{ tower.filename.cert_file }}'
      file:
        template.cert_file: !unsafe '{{ priv_key }}'
...
----

- Link to the roles documenation here:
+
* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_credential_types[Credential types role,window=_blank]

=== Task 18 - Create credentials

- Create a file `config/all/credentials.yml` and add the required information to the list `controller_credentials` to configure the UI to look like the screenshot. Make it to look like the screenshot, but make sure to use parameters for the values.
*DO NOT PASTE YOUR PASSWORD IN CLEARTEXT FOR CREDENTIALS!*
+
[source,yaml,role=execute,subs="verbatim,attributes",title="config/all/credentials.yml"]
----
---
controller_credentials_all:
  - name: aap_admin
    credential_type: Red Hat Ansible Automation Platform
    organization: config_as_code
    description: aap admin account
    inputs:
      host: "{{ aap_hostname }}"
      username: "{{ aap_username }}"
      password: "{{ aap_password }}"
      verify_ssl: false

  - name: hub_service_account
    credential_type: automation_hub
    organization: config_as_code
    description: automation hub api account
    inputs:
      hostname: "{{ aap_hostname }}"
      username: "{{ aap_service_account_username }}"
      token: "{{ hub_token }}"
      verify_ssl: false

  - name: hub_certified
    credential_type: "Ansible Galaxy/Automation Hub API Token"
    organization: config_as_code
    inputs:
      url: "https://{{ aap_hostname }}/pulp_ansible/galaxy/rh-certified/"
      token: "{{ hub_token }}"

  - name: hub_published
    credential_type: "Ansible Galaxy/Automation Hub API Token"
    organization: config_as_code
    inputs:
      url: "https://{{ aap_hostname }}/pulp_ansible/galaxy/published/"
      token: "{{ hub_token }}"

  - name: hub_validated
    credential_type: "Ansible Galaxy/Automation Hub API Token"
    organization: config_as_code
    inputs:
      url: "https://{{ aap_hostname }}/pulp_ansible/galaxy/validated/"
      token: "{{ hub_token }}"

  - name: hub_community
    credential_type: "Ansible Galaxy/Automation Hub API Token"
    organization: config_as_code
    inputs:
      url: "https://{{ aap_hostname }}/pulp_ansible/galaxy/community/"
      token: "{{ hub_token }}"

  - name: cr_ah
    credential_type: Container Registry
    organization: config_as_code
    inputs:
      host: "{{ aap_hostname }}"
      username: "{{ aap_username }}"
      password: "{{ aap_password }}"
      verify_ssl: false

  - name: vault
    credential_type: Vault
    organization: config_as_code
    description: vault password
    inputs:
      vault_password: "{{ vault_pass }}"

  - name: gitea
    credential_type: Source Control
    organization: config_as_code
    description: gitea
    inputs:
      username: ### Insert gitea username here
      password: ### Insert gitea pass variable here

...

----
+
image::07-configuration-as-code/credential_gitea_v2.png[title="Credential",125%,125%, link=self, window=blank]

- Link to the roles documenation here:
+
* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_credentials[Credentials role,window=_blank]

=== Task 19 - Create organizations

- Update the file `config/all/organizations.yml` and add the required information to the list `aap_organizations` to configure the UI to look like the screenshot. Here we are adding the `galaxy_credentials` credentials that we created above to the Organization so we can pull collections from Automation Hub, as well as setting a `default_environment`.
+
image::07-configuration-as-code/orgs.png[title="Config as Code Organization",125%,125%, link=self, window=blank]
+
[source,yaml,role=execute,subs="verbatim,attributes",title="Update config/all/organizations.yml"]
----
---
aap_organizations_all:
  - name: config_as_code
...
----

- Link to the roles documenation here:

* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/gateway_organizations[Organizations role,window=_blank]

=== Task 20 - Create projects

- Create a file `config/all/projects.yml` and add the required
information to the list `controller_projects` to configure the UI to
look like the screenshot. The Source control URL you want to use is **your gitea repo url**

WARNING: There are some values such as `project base path`, `playbook directory`, and `source control version` that are generated by AAP and are not options

NOTE: You will want to refer to the role documentation to determine which options need to be set
// TODO - What git project are we pointing at? Also, perhaps consider providing a table with the values they need to set so they can at least copy/paste URLs etc, but still have to look up the options required

[source,yaml,role=execute,subs="verbatim,attributes",title="config/all/projects.yml"]
----
---
controller_configuration_projects_async_delay: 5
controller_projects_all:

...
----

image::07-configuration-as-code/project_v2.png[title="Project",125%,125%, link=self, window=_blank]

- Link to the roles documenation here:
+
* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_projects[Projects role,window=_blank]

=== Task 21 - Create inventories

- Create a file `config/all/inventories.yml` and add the required
information to the list `controller_inventories` to configure the UI
to look like the screenshot
+
[source,yaml,role=execute,subs="verbatim,attributes",title="config/all/inventories.yml"]
----
---
controller_inventories_all:
...
----
+
image::07-configuration-as-code/inventories_v2.png[title="Inventory",125%,125%, link=self, window=_blank]

- Link to the roles documenation here:

* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_inventories[Inventories role,window=_blank]

=== Task 22 - Create inventory sources

- Add to file `config/all/inventory_sources.yml` and a new variable with the required information to the list `controller_inventory_sources` to configure the UI to look like the screenshot
+
[source,yaml,role=execute,subs="verbatim,attributes",title="config/all/inventory_sources.yml"]
----
---
controller_inventory_sources_all:
  - name: config_as_code_source
    organization: config_as_code
    source: scm
    source_project: ### Insert name of project
    source_path: ### Insert hosts file here
    inventory: config_as_code
    credential: ""
    verbosity: 0
    overwrite: true
    overwrite_vars: true
...
----
+
image::07-configuration-as-code/inventory_sources_v2.png[title="Inventory Sources",125%,125%, link=self, window=_blank]

- Link to the roles documenation here:
+
* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_inventory_sources[Inventory sources role,window=_blank]

=== Task 23 - Create job_templates

- Create a file `config/all/job_templates.yml` and add the required
information to the list `controller_templates` to configure the UI to like the screenshot.
+
Pay attention to the credentials attached to each job template.
+
[source,yaml,role=execute,subs="verbatim,attributes",title="config/all/job_templates.yml"]
----
---
controller_templates_all:

...
----
+
image::07-configuration-as-code/aap_config_template_v3.png[title="AAP Config Template",125%,125%, link=self, window=_blank]

- Link to the roles documenation here:
+
* https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_job_templates[Job templates role,window=_blank]

=== Task 24 - Update the Playbook
==== Update the playbook to get the hub token for the configuration

- We need to create a token from Automation Hub so that we can provide it to the Platform for the collection syncing to take place.
+
The next step is to create a playbook/file `playbooks/aap_config.yml` that will call the aap_configuration dispatch role which will apply all provided configurations in the order that they need to be created.
+
[source,yaml,role=execute,subs="verbatim,attributes",title="Updated playbooks/aap_config.yml"]
----
---
- name: Playbook to configure ansible controller
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    dispatch_include_wildcard_vars: true
  tasks:
    - name: Include common vars
      ansible.builtin.include_vars:
        dir: ../config/all
        extensions:
          - 'yml'

    - name: Include env vars
      ansible.builtin.include_vars:
        dir: "../config/{{ env }}"
        extensions:
          - 'yml'

    - name: Tasks to run if hub_token not defined
      when: hub_token is not defined
      block:
        - name: Authenticate and get an API token from Automation Hub
          ansible.hub.ah_token:
            ah_host: "{{ aap_hostname }}"
            ah_username: "{{ aap_username }}"
            ah_password: "{{ aap_password }}"
            ah_path_prefix: 'galaxy'  # this is for private automation hub
            ah_verify_ssl: false

        - name: Fixing format
          ansible.builtin.set_fact:
            hub_token: "{{ ah_token['token'] }}"

    - name: Call dispatch role
      ansible.builtin.include_role:
        name: infra.aap_configuration.dispatch

...

----

=== Task 25 - Run the playbook

- Run `playbooks/aap_config` playbook.
+
[source,console,role=execute,subs="verbatim,attributes"]
----
ansible-navigator run -m stdout playbooks/aap_config.yml -e env=dev
----

- If you run into problems, look back at the section that failed, and check the documentation for that role that was linked. If the output was hidden, look for 'Secure logging variables' on the https://github.com/redhat-cop/infra.aap_configuration/blob/devel/roles/controller_credentials[controller_credentials role documentation].

TIP: If you run into an error that says "Failed to get token: HTTP Error 401: Unauthorized" while other tasks pass, please rerun the playbook, this is a known issue.

=== Task 12 - See the Results

- After the playbook is complete you should be able to navigate to the controller and see all the changes.

== Conclusion

You have successfully implemented Configuration as Code for Ansible Automation Platform:

. Built custom Execution Environments with all required collections for AAP configuration
. Created structured variable files and encrypted secrets using Ansible Vault
. Configured organizations, teams, users, and service accounts
. Set up collection repositories, remotes, and automation credentials
. Deployed and configured Ansible projects, inventories, job templates, and workflows
. Executed the complete configuration using the infra.aap_configuration collection

This approach enables you to manage your entire AAP infrastructure as code, ensuring consistency, version control, and repeatability across environments. The skills learned here form the foundation for managing complex enterprise automation platforms.

== Helpful Links

For additional reference and deeper learning on Configuration as Code:

. https://github.com/redhat-cop/infra.aap_configuration[infra.aap_configuration Collection]
. https://docs.ansible.com/ansible/latest/user_guide/vault.html[Ansible Vault Documentation]
. https://docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/2.5/html/red_hat_ansible_automation_platform_installation_guide/index[Ansible Automation Platform Installation Guide]
. https://docs.ansible.com/ansible/latest/collections_guide/index.html[Ansible Collections Guide]
