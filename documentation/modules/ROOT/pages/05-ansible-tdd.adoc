= Lab: Collection Role Testing with Molecule

== 1. Introduction: Test-Driven Development with Molecule

Test-Driven Development (TDD) is a software development approach where tests are written before the code they validate. In Ansible automation, Molecule enables this practice by providing a framework for testing roles in isolated environments.

.Why use Molecule for Ansible roles?

. **Isolated Testing**: Tests run in clean, ephemeral containers ensuring consistent results.
. **Idempotence Verification**: Confirms roles can run multiple times without side effects.
. **Functional Testing**: Validates that roles actually work as intended, not just that they run.
. **CI/CD Integration**: Enables automated testing in pipelines before deployment.

== 2. Creating a role and writing tests for it

Now, let's create a role for our collection, then set up Molecule testing.

=== Step 2.1: Add the db_server Role

[source,bash,role=execute]
----
ansible-creator add resource role db_server .
----

== 3. Developing the db_server Role

Now we'll implement the db_server role to install and configure PostgreSQL with proper database setup.

[source,yaml,role=execute,title="roles/db_server/defaults/main.yml"]
----
---
# defaults file for db_server
db_name: "webapp_prod"
db_user: "webapp_user"
db_password: "SecurePassword123"
----

[source,yaml,role=execute,title="roles/db_server/tasks/main.yml"]
----
---
# tasks file for db_server
- name: Install PostgreSQL and dependencies
  ansible.builtin.package:
    name:
      - postgresql-server
      - python3-psycopg2
    state: present
  become: true

- name: Initialize the PostgreSQL database
  ansible.builtin.command: postgresql-setup --initdb
  args:
    creates: /var/lib/pgsql/data/postgresql.conf
  become: true

- name: Ensure the PostgreSQL service is started and enabled
  ansible.builtin.service:
    name: postgresql
    state: started
    enabled: true
  become: true

- name: Create the application database
  community.postgresql.postgresql_db:
    name: "{{ db_name }}"
    state: present
  become: true
  become_user: postgres

- name: Create the application database user
  community.postgresql.postgresql_user:
    name: "{{ db_user }}"
    password: "{{ db_password }}"
    state: present
  become: true
  become_user: postgres

- name: Grant the user full privileges on the new database
  community.postgresql.postgresql_privs:
    db: "{{ db_name }}"
    privs: ALL
    type: database
    roles: "{{ db_user }}"
    grant_option: false
  become: true
  become_user: postgres
----

== 4. Configuring Molecule Testing

Molecule will test our db_server role in an isolated container environment to ensure it works correctly.

=== Step 4.1: Initialize Molecule Scenario

From the root of your collection, initialize a Molecule scenario for the db_server role:

[source,bash,role=execute]
----
molecule init scenario db_server
----

=== Step 4.2: Configure Molecule Settings

Update the molecule configuration file to use Podman as the driver and include necessary collections:

[source,yaml,role=execute,title="extensions/molecule/db_server/molecule.yml"]
----
---
dependency:
  name: galaxy
  collections:
    - community.postgresql

driver:
  name: podman

platforms:
  - name: instance
    image: "registry.redhat.io/ubi9/ubi-init:latest"
    privileged: true
    tmpfs:
      - /tmp
      - /run
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:ro

provisioner:
  name: ansible
  inventory:
    group_vars:
      all:
        db_name: "webapp_prod"
        db_user: "webapp_user"
        db_password: "SecurePassword123"

verifier:
  name: ansible
----

=== Step 4.3: Update the Converge Playbook

Modify the converge playbook to use the full collection role name:

[source,yaml,role=execute,title="extensions/molecule/db_server/converge.yml"]
----
---
- name: Converge
  hosts: all
  tasks:
    - name: "Include the db_server role"
      ansible.builtin.include_role:
        name: "ansible_bootcamp.my_collection.db_server"
----

=== Step 4.4: Create Functional Tests

Create a verification playbook that performs functional testing of the database setup:

[source,yaml,role=execute,title="extensions/molecule/db_server/verify.yml"]
----
---
- name: Verify
  hosts: all
  tasks:
    - name: "FUNCTIONAL TEST: Connect as the new user and create a table"
      community.postgresql.postgresql_query:
        login_user: "{{ db_user }}"
        login_password: "{{ db_password }}"
        db: "{{ db_name }}"
        query: "CREATE TABLE IF NOT EXISTS molecule_verify (id INT);"

    - name: "FUNCTIONAL TEST: Write data to the new table"
      community.postgresql.postgresql_query:
        login_user: "{{ db_user }}"
        login_password: "{{ db_password }}"
        db: "{{ db_name }}"
        query: "INSERT INTO molecule_verify (id) VALUES (1);"

    - name: "FUNCTIONAL TEST: Read data back and verify the result"
      community.postgresql.postgresql_query:
        login_user: "{{ db_user }}"
        login_password: "{{ db_password }}"
        db: "{{ db_name }}"
        query: "SELECT COUNT(*) FROM molecule_verify;"
        register: query_result
        changed_when: false

    - name: "Assert that one record was found"
      ansible.builtin.assert:
        that:
          - query_result.query_result[0].count == 1
        fail_msg: "Verification failed! Expected to find 1 record but found {{ query_result.query_result[0].count }}."
        success_msg: "Verification successful! The DB user can connect, write, and read."
----

== 5. Running the Test Suite

Now let's execute the complete Molecule test suite to validate our db_server role.

=== Step 5.1: Execute the Tests

From the root of your `ansible_bootcamp.my_collection` directory, run the Molecule test suite:

[source,bash,role=execute]
----
molecule test -s db_server
----

NOTE: If you encounter issues with the container driver, ensure Podman is properly installed and configured for your environment.

=== Step 5.2: Understanding the Test Sequence

Molecule executes a comprehensive test sequence to validate your role:

. **Dependency:** Install required Ansible collections (community.postgresql)
. **Create:** Start an isolated Podman container with UBI9 base image
. **Prepare:** (Optional preparation steps - skipped in this scenario)
. **Converge:** Execute the db_server role to install and configure PostgreSQL
. **Idempotence:** Run the role again to verify no changes occur (ensures safe re-runs)
. **Verify:** Execute functional tests to validate database operations work correctly
. **Destroy:** Clean up the test container

The test suite validates that your db_server role successfully installs PostgreSQL, creates the application database and user, and enables functional database operations.

Further documentation are provided below for those who are interested to learn more:

* https://molecule.readthedocs.io/en/latest/[Molecule Documentation,window=_blank]
* https://ansible.readthedocs.io/projects/creator/[Ansible Creator Documentation,window=_blank]
* https://docs.ansible.com/ansible/latest/user_guide/collections_using.html[Ansible Collections Guide,window=_blank]

== 6. Conclusion

Congratulations! You have successfully implemented Test-Driven Development for Ansible automation by:

. Creating an Ansible collection with a db_server role
. Implementing PostgreSQL installation and configuration
. Configuring Molecule for isolated testing with functional verification
. Running comprehensive tests that validate role functionality and idempotence

This TDD approach ensures your automation is reliable, maintainable, and ready for production deployment. The skills you've learned here form the foundation for developing high-quality Ansible content that can be confidently deployed in enterprise environments.
