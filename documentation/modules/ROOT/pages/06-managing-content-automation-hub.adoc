= Lab: Managing Ansible Content with Private Automation Hub

[abstract]
We will create a custom collection, publish it to a Private Automation Hub (PAH), build a custom Execution Environment (EE) from a certified base image, and finally, run the automation from Ansible Automation Controller.

== 1. Introduction: The Role of Private Automation Hub

A Private Automation Hub acts as a central repository for your organization's curated and trusted automation content. It allows you to manage, share, and control access to your own Execution Environments and Ansible Content Collections.

.Why is this important?

. Centralized Control: A single source of truth for all your certified automation content.
. Security & Trust: Ensures that teams are using approved and vetted collections and EEs.
. Dependency Management: Simplifies dependency resolution by providing a private, trusted source for collections.
. Scalability: Enables the distribution of automation content across large organizations.

== 2. Lab Setup: Configuring Your Environment

First, let's configure everything to communicate with your Private Automation Hub.

=== Step 2.1: Configure Ansible to Use PAH via Environment Variables

Instead of creating a configuration file with your secret token, we will set environment variables. This is a more secure practice for local development as it prevents tokens from being accidentally committed to source control.

==== Step 2.1.1: Creating namespace for collection
. Log in to your Private Automation Hub web interface.
. From the navigation menu on the left, click on Namespaces.
. Click on the create namespace button.
. Put in `ansible_bootcamp` for the name, you can leave everything else blank and click create namespace.

==== Step 2.1.2: Obtaining Your PAH API Token
. Log in to your Private Automation Hub web interface.
. From the navigation menu on the left, click on API Token.
. On the API Token page, click the Load token button.
. Your API token will be displayed. Click the Copy to clipboard icon to copy it. You will use this in the next step.

==== Step 2.1.3: Sync collections
. Log in to your Private Automation Hub web interface.
. From the navigation menu on the left, click on Remotes.
. Click on create remote and call it `validated` with url being `https://console.redhat.com/api/automation-hub/content/validated/` SSO url `https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token` and token.
. From the navigation menu on the left, click on Repositories.
. Edit validated and for the `Remote` field choose validated from the drop down and save.
. Click on the triple dots for rh-certified and validated and select `Sync repository` and click sync on the popup.

NOTE: Syncing the certified collections will take some time, it is needed for another section so continue on and do not wait for it to finish.

==== Step 2.1.3: Set Environment Variables
In your terminal, run the following commands. These variables will configure ansible-galaxy and ansible-builder to use your PAH instance for the current terminal session.

[source,bash,role=execute]
----
# Set the list of servers Ansible should know about
export ANSIBLE_GALAXY_SERVER_LIST='published,certified,validated,community'

# Configure the 'published' repository
export ANSIBLE_GALAXY_SERVER_PUBLISHED_URL='https://pah.example.com/pulp_ansible/galaxy/published/'
export ANSIBLE_GALAXY_SERVER_PUBLISHED_TOKEN='YOUR_API_TOKEN_HERE'

# Configure the 'certified' repository
export ANSIBLE_GALAXY_SERVER_CERTIFIED_URL='https://pah.example.com/pulp_ansible/galaxy/rh-certified/'
export ANSIBLE_GALAXY_SERVER_CERTIFIED_TOKEN='YOUR_API_TOKEN_HERE'

# Configure the 'validated' repository
export ANSIBLE_GALAXY_SERVER_VALIDATED_URL='https://pah.example.com/pulp_ansible/galaxy/validated/'
export ANSIBLE_GALAXY_SERVER_VALIDATED_TOKEN='YOUR_API_TOKEN_HERE'

# Configure the 'community' repository
export ANSIBLE_GALAXY_SERVER_COMMUNITY_URL='https://pah.example.com/pulp_ansible/galaxy/community/'
export ANSIBLE_GALAXY_SERVER_COMMUNITY_TOKEN='YOUR_API_TOKEN_HERE'
----

NOTE: Replace the following values `pah.example.com` With the URL of your Private Automation Hub. Also update `YOUR_API_TOKEN_HERE` With the personal API token you just copied from PAH.

== 3. Creating and Publishing a Custom Collection

Now, let's use ansible-creator to scaffold a new collection.

=== Step 3.1: Initialize the Collection with ansible-creator

[source,bash,role=execute]
----
# Create a main project directory
mkdir my_pah_project
cd my_pah_project

# Initialize the collection structure using ansible-creator
ansible-creator init ansible_bootcamp.my_collection --init-path ./
----

WARNING: Remove ansible.utils from deps list

=== Step 3.2: Build and Publish the Collection

[source,bash,role=execute]
----
# Build your custom collection
ansible-galaxy collection build

# Publish the collection to PAH
ansible-galaxy collection publish -s https://aap.example.com/api/galaxy/ ansible_bootcamp-my_collection-1.0.0.tar.gz --token <token>
----

NOTE: Replace the following values `pah.example.com` With the URL of your Private Automation Hub

NOTE: Make sure to Approve collection in the hub UI

== 4. Push Collection to Repository

After we've published our collection to your Private Automation Hub, we need to save our work your lab's Gitea.

=== 4.1 Create Gitea Repository

. Log in to your Gitea web interface, with the provided login credentials.
. In the top left of the web interface, click on the '+' symbol and select 'New Repository'.
. On the New Repository page, enter 'ansible_bootcamp_ci_cd_pipeline' in the Repository Name field.
. Leave everything else as default and click on the button at the bottom, 'Create Repository'.

=== 4.2 Push collection to new repository

After an empty repository is created on your Gitea, we need to push the collection to the repository.

. In section 'Clone this repository', click the Copy URL button on the far right to copy Gitea repository URL, that will be pasted below in line that starts with 'git remote add origin ...'.
. Now, follow these steps in the root directory of 'my_pah_project'

[source,bash,role=execute]
----
git config --global user.email "gitea@opentlc.com"
git config --global user.name <YOUR NAME>
git init
git checkout -b main
git add --all
git commit -m "Uploading collection on initial commit"
git remote add origin <PASTE GIT URL FROM GITEA HERE>
git push -u origin main
----

Verify the collection is now pushed to the Gitea repository, as it will be referenced later in the Ansible Bootcamp Lab: xref:07-ansible-cicd.adoc[Creating a CI/CD Pipeline]. 

== 5. Syncing a Base EE from the Red Hat Registry

Before building our own EE, we'll configure PAH to pull in a certified base image from Red Hat.

. In your Private Automation Hub UI, navigate to Execution Environments -> Remote Registries.
. Click Add remote registry and configure it for registry.redhat.io with your credentials.
. Once saved, edit the registry and add ansible-execution-env/ee-minimal-rhel9 to the include tags list.
. Save and Sync the registry.
. After the sync is complete, the ee-minimal-rhel9 image will be available in your Private Automation Hub.

== 6. Building a Custom Execution Environment

Now, we'll define and build an EE that uses our synced minimal image and our custom collection.

=== Step 6.1: Define the Execution Environment

Create a file named execution-environment.yml.

[source,yaml,title="execution-environment.yml",role=execute]
----
---
version: 3

images:
  base_image:
    name: aap.example.com/ansible-automation-platform-25/ee-minimal-rhel9:latest

dependencies:
  ansible_core:
    package_pip: ansible-core==2.16.14
  galaxy:
    collections:
      - name: ansible_bootcamp.my_collection
        version: 1.0.0
options:
  package_manager_path: /usr/bin/microdnf

additional_build_steps:
  prepend_galaxy:
    - ARG TOKEN
    - ENV ANSIBLE_GALAXY_SERVER_LIST='published,certified,validated,community'
    - ENV ANSIBLE_GALAXY_SERVER_CERTIFIED_URL='https://aap.example.com/pulp_ansible/galaxy/rh-certified/'
    - ENV ANSIBLE_GALAXY_SERVER_CERTIFIED_TOKEN=$TOKEN
    - ENV ANSIBLE_GALAXY_SERVER_VALIDATED_URL='https://aap.example.com/pulp_ansible/galaxy/validated/'
    - ENV ANSIBLE_GALAXY_SERVER_VALIDATED_TOKEN=$TOKEN
    - ENV ANSIBLE_GALAXY_SERVER_COMMUNITY_URL='https://aap.example.com/pulp_ansible/galaxy/community/'
    - ENV ANSIBLE_GALAXY_SERVER_COMMUNITY_TOKEN=$TOKEN
    - ENV ANSIBLE_GALAXY_SERVER_PUBLISHED_URL='https://aap.example.com/pulp_ansible/galaxy/published/'
    - ENV ANSIBLE_GALAXY_SERVER_PUBLISHED_TOKEN=$TOKEN
----

NOTE: Replace the following values `pah.example.com` With the URL of your Private Automation Hub.

=== Step 6.2: Build and Publish the Execution Environment

[source,bash,role=execute]
----
# Log in to your PAH container registry
podman login pah.example.com

# Build the EE. It will pull the base from PAH, then add our content.
ansible-builder build --tag my-pah-ee:1.0 --build-arg TOKEN=YOUR_API_TOKEN_HERE

# Tag and push the image to your PAH registry
podman tag localhost/my-pah-ee:1.0 pah.example.com/my-pah-ee:1.0
podman push pah.example.com/my-pah-ee:1.0
----

NOTE: Replace the following values `pah.example.com` With the URL of your Private Automation Hub. Also update `YOUR_API_TOKEN_HERE` With the personal API token you just copied from PAH.

== 7. Adding a Custom Filter Plugin

Now that we have a working EE, let's iterate by adding a custom filter plugin to our collection.

=== Step 7.1: Create the Custom Filter Plugin

Create the file with the following content:

[source,python,title="plugins/filter/cowsay_filter.py",role=execute]
----
from __future__ import (absolute_import, division, print_function)
__metaclass__ = type

DOCUMENTATION = '''
    name: cowsay
    short_description: A filter to wrap text in a cowsay bubble.
    description:
        - This filter takes a string and returns it formatted by the cowsay library.
    requirements:
      - The `cowsay` python library must be installed.
'''

try:
    import cowsay
except ImportError:
    cowsay = None

def cowsay_filter(text):
    if not cowsay:
        raise AnsibleFilterError("The 'cowsay' Python library is not installed. Cannot use filter.")
    return cowsay.cow(text)

class FilterModule(object):
    def filters(self):
        return {
            'cowsay': cowsay_filter
        }
----

=== Step 7.2: Update the EE Definition for the Plugin Dependency

Our new plugin requires the cowsay Python library, and we need to ensure our EE is pulling the new version of our collection. Modify execution-environment.yml to include both changes.

[source,yaml,title="execution-environment.yml",role=execute]
----
---
version: 3

images:
 base_image:
   name: aap.example.com/ansible-automation-platform-25/ee-minimal-rhel9:latest

dependencies:
 ansible_core:
   package_pip: ansible-core==2.16.14
 galaxy:
   collections:
     - name: ansible_bootcamp.my_collection
       version: 1.0.1
 python:
   - cowsay
options:
 package_manager_path: /usr/bin/microdnf

additional_build_steps:
 prepend_galaxy:
   - ARG TOKEN
   - ENV ANSIBLE_GALAXY_SERVER_LIST='published,certified,validated,community'
   - ENV ANSIBLE_GALAXY_SERVER_CERTIFIED_URL='https://aap.example.com/pulp_ansible/galaxy/rh-certified/'
   - ENV ANSIBLE_GALAXY_SERVER_CERTIFIED_TOKEN=$TOKEN
   - ENV ANSIBLE_GALAXY_SERVER_VALIDATED_URL='https://aap.example.com/pulp_ansible/galaxy/validated/'
   - ENV ANSIBLE_GALAXY_SERVER_VALIDATED_TOKEN=$TOKEN
   - ENV ANSIBLE_GALAXY_SERVER_COMMUNITY_URL='https://aap.example.com/pulp_ansible/galaxy/community/'
   - ENV ANSIBLE_GALAXY_SERVER_COMMUNITY_TOKEN=$TOKEN
   - ENV ANSIBLE_GALAXY_SERVER_PUBLISHED_URL='https://aap.example.com/pulp_ansible/galaxy/published/'
   - ENV ANSIBLE_GALAXY_SERVER_PUBLISHED_TOKEN=$TOKEN
----

NOTE: Replace the following values `pah.example.com` With the URL of your Private Automation Hub.

=== Step 7.3: Increment Version and Republish

Now, we publish a new version of the collection and a new version of the EE that includes the updated collection and dependency.

First, edit `galaxy.yml` and change the version from `1.0.0` to `1.0.1`.

Then, run the following commands:

[source,bash,role=execute]
----
# Rebuild and republish the collection
cd my_pah_project
ansible-galaxy collection build
ansible-galaxy collection publish -s https://aap.example.com/api/galaxy/ ansible_bootcamp-my_collection-1.0.1.tar.gz --token YOUR_API_TOKEN_HERE
----

NOTE: Replace the following values `pah.example.com` With the URL of your Private Automation Hub. Also update `YOUR_API_TOKEN_HERE` With the personal API token you just copied from PAH.

NOTE: Make sure to Approve collection in the hub UI

[source,bash,role=execute]
----
# Rebuild and republish the EE with a new version tag
ansible-builder build --tag my-pah-ee:1.1 --build-arg TOKEN=YOUR_API_TOKEN_HERE
podman tag localhost/my-pah-ee:1.1 pah.example.com/my-pah-ee:1.1
podman push pah.example.com/my-pah-ee:1.1
----

NOTE: Replace the following values `pah.example.com` With the URL of your Private Automation Hub.

== 8. Preparing the Project for Automation Controller

Now we'll update our playbook to use the new filter.

=== Step 8.1: Create a Playbook

Create a playbook named `playbooks/test_pah_ee.yml`. This playbook uses the debug module to print a message that has been formatted by our custom cowsay filter.

[source,yaml,title="playbooks/test_pah_ee.yml",role=execute]
----
---
- name: Test custom filter from Private Automation Hub
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
    - name: Print a message using the cowsay filter
      ansible.builtin.debug:
        msg: "{{ 'Hello from my custom filter!' | ansible_bootcamp.my_collection.cowsay }}"
...
----

=== Step 8.2: Push Project Files to Git

Push the `test_pah_ee.yml` playbook to your Git repository

== 9. Integrating with Automation Controller

Now, let's configure Controller to use our custom content.

=== Step 9.1: Create a Credential for Hub Container Registry
. Navigate to Resources -> Credentials and click Add.
. Name it Hub, select the type Container Registry, and fill out your "Authentication URL", "username", "password".

=== Step 9.2: Add the Execution Environment to Controller
. In the Controller UI, navigate to Infrastructure -> Execution Environments.
. Click Add, name it My Custom PAH EE, and use the image path `pah.example.com/my-pah-ee:1.1`.
. Select your Hub credential as the registry credential and Save.

=== Step 9.3: Create a Project
. Navigate to Resources -> Projects and click Add.
. Name it Custom Content Test Project and point it to your Git repository URL.
. Under Ansible Galaxy Credentials, select the PAH Galaxy Credential you just created.
. Click Save and Sync the project.

=== Step 9.4: Create a Job Template
. Navigate to Resources -> Templates and click Add -> Add job template.
. Name it Test Custom Cowsay Filter.
. Select an Inventory, the Custom Content Test Project, and the playbooks/test_pah_ee.yml playbook.
. For the Execution Environment, select My Custom PAH EE.
. Click Save.

=== Step 9.5: Launch the Job Template and Verify
. From the Job Templates view, click the rocket icon ðŸš€ to Launch your template.
. In the job output view, look for the output of the "Print a message" task. You should see your message printed inside a cowsay bubble within the JSON output of the debug task.

== 10. Conclusion

Congratulations! You have successfully completed this workflow for managing custom Ansible content:

. Configured your local environment to connect to a Private Automation Hub.
. Built and published a custom collection.
. Synced a certified base EE from Red Hat into your PAH.
. Iterated on your content by adding a filter plugin and its dependencies.
. Built and published a custom Execution Environment on top of the certified base image.
. Configured Automation Controller to use all of your custom content.
. Verified the entire process by launching a Job Template.
. This process is fundamental to creating a secure, scalable, and manageable automation practice in an enterprise environment.
